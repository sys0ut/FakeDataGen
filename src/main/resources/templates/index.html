<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fake Data Generator</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="container-narrow">
        <div class="brand" style="margin-bottom:18px;">
            <span style="font-size:1.1rem;color:#8b93a7;">Fake Data Generator</span>
        </div>

        <!-- 연결 설정 -->
        <div class="panel" style="margin-bottom:16px;">
            <div class="panel-header"><span>연결 설정</span><button class="btn btn-ghost" onclick="testConnection()">연결 테스트</button></div>
            <div class="panel-body" id="connectionPanelBody">
                <div id="connectionAlert" style="display:none; margin-bottom:16px; padding:12px 16px; border-radius:10px; font-size:0.9rem;"></div>
                <div class="grid grid-2">
                    <div>
                        <label for="dbHost">호스트</label>
                        <input type="text" id="dbHost" name="dbHost">
                    </div>
                    <div>
                        <label for="dbPort">포트</label>
                        <input type="number" id="dbPort" name="dbPort">
                    </div>
                    <div>
                        <label for="dbName">DB 이름</label>
                        <input type="text" id="dbName" name="dbName">
                    </div>
                    <div>
                        <label for="dbUsername">사용자</label>
                        <input type="text" id="dbUsername" name="dbUsername">
                    </div>
                    <div>
                        <label for="dbPassword">비밀번호</label>
                        <input type="password" id="dbPassword" name="dbPassword">
                    </div>
                </div>
            </div>
        </div>

        <!-- 스키마 입력 -->
        <div class="panel">
            <div class="panel-header"><span>스키마 입력</span></div>
            <div class="panel-body">
                <form th:action="@{/parse}" method="post" onsubmit="addDbInfoToForm(this)">
                            <!-- 데이터베이스 연결 정보를 숨겨진 필드로 추가 -->
                            <input type="hidden" name="dbHost" id="formDbHost">
                            <input type="hidden" name="dbPort" id="formDbPort">
                            <input type="hidden" name="dbName" id="formDbName">
                            <input type="hidden" name="dbUsername" id="formDbUsername">
                            <input type="hidden" name="dbPassword" id="formDbPassword">
                            
                    <div class="mb-3">
                        <label for="schemaText">CUBRID DDL 스키마</label>
                        <textarea id="schemaText" name="schemaText" required></textarea>
                    </div>
                            
                    <div class="grid grid-3">
                        <div>
                            <label for="recordCount">레코드 수</label>
                            <input type="number" id="recordCount" name="recordCount" min="1" max="1000000" value="100000">
                        </div>
                        <div>
                            <label>DB INSERT</label>
                            <div style="margin-top:8px">
                                <input type="checkbox" id="insertToDatabase" name="insertToDatabase" value="true"> <span class="muted">실제 DB에 저장</span>
                            </div>
                        </div>
                        <div>
                            <label>CUBRID 버전</label>
                            <div style="margin-top:8px">
                                <input type="checkbox" id="cubridVersion112" name="cubridVersion112" value="true"> <span class="muted">11.2 이상</span>
                            </div>
                        </div>
                    </div>
                    <div class="spacer"></div>
                    <button type="submit" class="btn btn-primary" id="submitBtn">가짜 데이터 생성</button>
                        </form>
                    </div>
                </div>
                
                <div class="muted" style="margin-top:14px">CREATE/ALTER CLASS 중심의 DDL을 지원합니다.</div>
            </div>
        </div>
    </div>
    <!-- 로딩 오버레이 -->
    <div id="loadingOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:#1a1a1a; padding:32px; border-radius:12px; text-align:center; max-width:400px; border:1px solid rgba(255,255,255,0.1);">
            <div style="margin-bottom:16px;">
                <div style="width:48px; height:48px; border:4px solid rgba(255,255,255,0.1); border-top-color:#4ecdc4; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto;"></div>
            </div>
            <div style="font-size:1.1rem; color:#fff; margin-bottom:8px">데이터 생성 중...</div>
            <div style="font-size:0.9rem; color:#888" id="loadingMessage">잠시만 기다려주세요</div>
            <div style="margin-top:16px; font-size:0.85rem; color:#666">건수가 많을 경우 시간이 걸릴 수 있습니다</div>
        </div>
    </div>
    
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    
    <script>
        function addDbInfoToForm(form) {
            const dbHost = document.getElementById('dbHost').value;
            const dbPort = document.getElementById('dbPort').value;
            const dbName = document.getElementById('dbName').value;
            const dbUsername = document.getElementById('dbUsername').value;
            const dbPassword = document.getElementById('dbPassword').value;
            const insertToDatabase = document.getElementById('insertToDatabase').checked;
            const recordCount = document.getElementById('recordCount').value;
            
            console.log('폼 제출 시 데이터베이스 정보:');
            console.log('dbHost:', dbHost);
            console.log('dbPort:', dbPort);
            console.log('dbName:', dbName);
            console.log('dbUsername:', dbUsername);
            console.log('dbPassword:', dbPassword ? '***' : 'null');
            console.log('insertToDatabase:', insertToDatabase);
            console.log('recordCount:', recordCount);
            
            document.getElementById('formDbHost').value = dbHost;
            document.getElementById('formDbPort').value = dbPort;
            document.getElementById('formDbName').value = dbName;
            document.getElementById('formDbUsername').value = dbUsername;
            document.getElementById('formDbPassword').value = dbPassword;
            
            const overlay = document.getElementById('loadingOverlay');
            const submitBtn = document.getElementById('submitBtn');
            const loadingMessage = document.getElementById('loadingMessage');
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '처리 중...';
            
            if (recordCount > 100000) {
                loadingMessage.textContent = recordCount.toLocaleString() + '개 레코드 생성 중... (시간이 걸릴 수 있습니다)';
            } else {
                loadingMessage.textContent = recordCount.toLocaleString() + '개 레코드 생성 중...';
            }
            
            overlay.style.display = 'flex';
            
            return true;
        }
        
        function testConnection() {
            const formData = new FormData();
            formData.append('dbHost', document.getElementById('dbHost').value);
            formData.append('dbPort', document.getElementById('dbPort').value);
            formData.append('dbName', document.getElementById('dbName').value);
            formData.append('dbUsername', document.getElementById('dbUsername').value);
            formData.append('dbPassword', document.getElementById('dbPassword').value);
            
            const testBtn = document.querySelector('button[onclick="testConnection()"]');
            testBtn.disabled = true;
            testBtn.innerHTML = '🔄 테스트 중...';
            
            const alertDiv = document.getElementById('connectionAlert');
            
            fetch('/test-connection', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                alertDiv.style.display = 'block';
                alertDiv.style.background = data.success ? 'rgba(89, 212, 153, 0.15)' : 'rgba(244, 67, 54, 0.15)';
                alertDiv.style.border = data.success ? '1px solid rgba(89, 212, 153, 0.3)' : '1px solid rgba(244, 67, 54, 0.3)';
                alertDiv.style.color = data.success ? '#59d499' : '#f44336';
                alertDiv.textContent = data.message;
            })
            .catch(error => {
                console.error('Error:', error);
                alertDiv.style.display = 'block';
                alertDiv.style.background = 'rgba(244, 67, 54, 0.15)';
                alertDiv.style.border = '1px solid rgba(244, 67, 54, 0.3)';
                alertDiv.style.color = '#f44336';
                alertDiv.textContent = '연결 테스트 중 오류가 발생했습니다.';
            })
            .finally(() => {
                testBtn.disabled = false;
                testBtn.innerHTML = '연결 테스트';
            });
        }
    </script>
</body>
</html>
